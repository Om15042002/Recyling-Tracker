{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}Approve Request #{{ recycling_request.id }} - EcoTracker{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            Approve Request #{{ recycling_request.id }}
                        </h4>
                        <a href="{% url 'staff_requests' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Back to Requests
                        </a>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Request Summary -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            {% if recycling_request.item_image %}
                                <img src="{{ recycling_request.item_image.url }}" class="img-fluid rounded shadow-sm" alt="Request image" style="max-height: 200px; width: 100%; object-fit: cover;">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 200px;">
                                    <i class="fas fa-image fa-4x text-muted"></i>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-8">
                            <h5 class="text-success mb-3">Request Details</h5>
                            <div class="row">
                                <div class="col-sm-6">
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <strong>User:</strong> {{ recycling_request.user.get_full_name|default:recycling_request.user.username }}
                                        </li>
                                        <li class="mb-2">
                                            <strong>Email:</strong> {{ recycling_request.user.email }}
                                        </li>
                                        <li class="mb-2">
                                            <strong>Material:</strong> {{ recycling_request.get_material_type_display }}
                                        </li>
                                        <li class="mb-2">
                                            <strong>Quantity:</strong> {{ recycling_request.quantity }} item{{ recycling_request.quantity|pluralize }}
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-sm-6">
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <strong>Priority:</strong> 
                                            <span class="badge bg-{% if recycling_request.priority == 'urgent' %}danger{% elif recycling_request.priority == 'high' %}warning{% elif recycling_request.priority == 'medium' %}info{% else %}secondary{% endif %}">
                                                {{ recycling_request.get_priority_display }}
                                            </span>
                                        </li>
                                        <li class="mb-2">
                                            <strong>Submitted:</strong> {{ recycling_request.created_at|date:"M d, Y g:i A" }}
                                        </li>
                                        {% if recycling_request.estimated_weight %}
                                        <li class="mb-2">
                                            <strong>Weight:</strong> {{ recycling_request.estimated_weight }} kg
                                        </li>
                                        {% endif %}
                                        {% if recycling_request.preferred_pickup_date %}
                                        <li class="mb-2">
                                            <strong>Preferred Pickup:</strong> {{ recycling_request.preferred_pickup_date|date:"M d, Y" }}
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <h6 class="text-success mb-2">Item Description</h6>
                        <p class="text-muted bg-light p-3 rounded">{{ recycling_request.item_description }}</p>
                        
                        {% if recycling_request.notes %}
                        <h6 class="text-success mb-2 mt-3">Additional Notes</h6>
                        <p class="text-muted bg-light p-3 rounded">{{ recycling_request.notes }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Pickup Information -->
                    <div class="mb-4">
                        <h6 class="text-success mb-2">Pickup Information</h6>
                        <div class="card border-info border-opacity-25">
                            <div class="card-body">
                                <p class="mb-2">
                                    <i class="fas fa-map-marker-alt text-info me-2"></i>
                                    <strong>Address:</strong> {{ recycling_request.pickup_address }}
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-building text-info me-2"></i>
                                    <strong>Center:</strong> {{ recycling_request.recycling_center.name }}
                                </p>
                                {% if recycling_request.preferred_pickup_date %}
                                <p class="mb-0">
                                    <i class="fas fa-calendar text-info me-2"></i>
                                    <strong>Preferred Date:</strong> {{ recycling_request.preferred_pickup_date|date:"l, F d, Y \a\t g:i A" }}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Approval Form -->
                    <form method="post" class="approval-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="approve">
                        
                        <div class="mb-4">
                            <h6 class="text-success mb-3">Approval Details</h6>
                            
                            <div class="mb-3">
                                <label for="staff_notes" class="form-label">Staff Notes</label>
                                <textarea class="form-control" id="staff_notes" name="staff_notes" rows="4" placeholder="Add any notes or instructions for the pickup team..."></textarea>
                                <div class="form-text">These notes will be visible to the user and pickup team.</div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'staff_requests' %}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            <button type="button" class="btn btn-outline-danger me-md-2" data-bs-toggle="modal" data-bs-target="#rejectModal">
                                <i class="fas fa-ban me-1"></i>Reject Request
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check me-1"></i>Approve Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar with additional info -->
        <div class="col-lg-4">
            <!-- User Information -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-user me-2"></i>User Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-user-circle fa-4x text-muted"></i>
                        <h6 class="mt-2 mb-1">{{ recycling_request.user.get_full_name|default:recycling_request.user.username }}</h6>
                        <small class="text-muted">{{ recycling_request.user.email }}</small>
                    </div>
                    
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <strong>Member since:</strong> {{ recycling_request.user.date_joined|date:"M Y" }}
                        </li>
                        <li class="mb-2">
                            <strong>Total requests:</strong> {{ user_total_requests }}
                        </li>
                        <li class="mb-2">
                            <strong>Completed:</strong> {{ user_completed_requests }}
                        </li>
                        <li class="mb-0">
                            <strong>User type:</strong> {{ recycling_request.user.userprofile.get_user_type_display|default:"Regular User" }}
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Recent Activity
                    </h6>
                </div>
                <div class="card-body">
                    <div class="timeline-sm">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <small class="text-muted">{{ recycling_request.created_at|timesince }} ago</small>
                                <p class="mb-0">Request submitted</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="card shadow-sm border-0 bg-light">
                <div class="card-body text-center">
                    <h6 class="text-success mb-3">Environmental Impact</h6>
                    <div class="row">
                        <div class="col-6">
                            <h4 class="text-success">{{ recycling_request.estimated_weight|default:1|floatformat:1 }}</h4>
                            <small class="text-muted">kg to recycle</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">{{ recycling_request.estimated_weight|default:1|mul:2.2|floatformat:1 }}</h4>
                            <small class="text-muted">kg COâ‚‚ saved</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-ban me-2"></i>Reject Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="reject">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Are you sure you want to reject this request?</strong>
                        <br>The user will be notified about this rejection.
                    </div>
                    
                    <div class="mb-3">
                        <label for="staff_notes" class="form-label">Reason for Rejection *</label>
                        <textarea class="form-control" id="staff_notes" name="staff_notes" rows="4" 
                                placeholder="Please provide a clear reason for rejecting this request..." required></textarea>
                        <div class="form-text">This reason will be shared with the user.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban me-1"></i>Reject Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.approval-form {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.timeline-sm {
    position: relative;
    padding-left: 1.5rem;
}

.timeline-sm::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 1rem;
}

.timeline-item:last-child {
    margin-bottom: 0;
}

.timeline-marker {
    position: absolute;
    left: -1rem;
    top: 0.25rem;
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    border: 2px solid white;
}

.timeline-content {
    font-size: 0.875rem;
}

@media (max-width: 992px) {
    .col-lg-4 {
        margin-top: 2rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Request approval page loaded for request #{{ recycling_request.id }}');
});
</script>
{% endblock %}
